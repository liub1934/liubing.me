import{_ as i,c as a,a as t,o as n}from"./app-kBHCaxRY.js";const p={};function r(l,e){return n(),a("div",null,[...e[0]||(e[0]=[t(`<h1 id="宝塔面板升级兰空图床-lsky-pro-到-2x-版本" tabindex="-1"><a class="header-anchor" href="#宝塔面板升级兰空图床-lsky-pro-到-2x-版本"><span>宝塔面板升级兰空图床 Lsky Pro 到 2x 版本</span></a></h1><p>之前一直用的是兰空图床 Lsky Pro，版本也是 1x 的版本，里面也上传了不少的图片，最近看到该图床也升级到了 2x 的版本，看了下<a href="https://docs.lsky.pro/archive/free/v2/#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97" target="_blank" rel="noopener noreferrer">升级指南</a>才知道 2x 版本与 1x 存在巨大差异需要手动升级，乘着周末有时间搞一下，记录下升级过程。</p><h2 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作"><span>准备工作</span></a></h2><p>我们可以参照文档说明做些准备工作</p><ul><li>先安装全新的 2.0 版本，安装成功后不要进行任何操作</li><li>保证旧版本只有一个管理员账号</li><li>需要将旧版本中的所有用到的储存策略配置填上访问域名，保证该储存策略的图片能正常通过该域名访问</li><li>如果使用第三方储存，需要关闭防盗链等一切访问限制，避免图像尺寸获取失败</li></ul><p>我们按照文档教程全新安装一个 2x 的版本，由于自己使用的是本地存储的策略，就可以不用管其他第三方存储了。</p><p>之前的访问域名是<code>image.liubing.me</code>，为了升级过程中不影响老的版本的正常使用，这次单独解析了一个新的<code>img.liubing.me</code>给这次升级使用。</p><h2 id="安装环境" tabindex="-1"><a class="header-anchor" href="#安装环境"><span>安装环境</span></a></h2><p>从文档上的<a href="https://docs.lsky.pro/docs/free/v2/#%E5%AE%89%E8%A3%85%E8%A6%81%E6%B1%82" target="_blank" rel="noopener noreferrer">安装要求</a>中可以得知 PHP 最低的版本都得<code>&gt;= 8.0.2</code>，由于之前使用的是<code>7.x</code>的版本，所以得先去宝塔面板的软件商店中安装 PHP <code>8.1x</code>的版本。</p><p>如果你的数据库版本也低于下列的版本的话需要安装制定的版本。</p><ul><li>Mysql 5.7+</li><li>PostgreSQL 9.6+</li><li>SQLite 3.8.8+</li><li>SQL Server 2017+</li></ul><p>添加站点的过程忽略了，相信你们会的。添加站点的时候记得 PHP 版本选择<code>8.1x</code>，运行目录设置成<code>/public</code>。</p><h3 id="安装扩展" tabindex="-1"><a class="header-anchor" href="#安装扩展"><span>安装扩展</span></a></h3><p>安装完成后按文档要求安装以下的扩展：</p><ul><li>BCMath PHP 扩展</li><li>Ctype PHP 扩展</li><li>DOM PHP 拓展</li><li>Fileinfo PHP 扩展</li><li>JSON PHP 扩展</li><li>Mbstring PHP 扩展</li><li>OpenSSL PHP 扩展</li><li>PDO PHP 扩展</li><li>Tokenizer PHP 扩展</li><li>XML PHP 扩展</li><li>Imagick 拓展</li></ul><p>有些扩展已经自带了，只需要安装<code>fileinfo</code>和<code>imagemagick</code>即可。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8aeeaefef5.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><h3 id="删除禁用函数" tabindex="-1"><a class="header-anchor" href="#删除禁用函数"><span>删除禁用函数</span></a></h3><p>此外还需要将默认的一些函数从禁用列表中删除</p><ul><li>exec、shell_exec 函数</li><li>readlink、symlink 函数</li><li>putenv、getenv 函数</li></ul><p>在<code>禁用函数</code>中<code>Ctrl + F</code>搜索相关函数，如果有的话点击右侧的删除按钮删除掉。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8af7c468f6.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>扩展和禁用函数有更改的时候需要重启下 PHP 服务</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b01b67cf2.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><h2 id="安装程序" tabindex="-1"><a class="header-anchor" href="#安装程序"><span>安装程序</span></a></h2><p>这时候访问域名就能进入安装界面了，如果上述扩展都安装了，被禁用的函数也都删除后该页面环境检测都是打勾 OK 的。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b19bab8c5.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>点击下一步进入到数据库和管理员账号配置，按实际情况填写。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>注意要使用新的数据库，不要填写旧版本连接的数据库。管理员账号建议和原来的旧版本保持一致。</p></div><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b2759afaf.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>点击立即安装，不出意外的话过一会就显示安装完成的界面。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b33ae497f.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>安装完成后就先暂时不用管这个页面了，接下来就是数据迁移工作了。</p><h2 id="数据迁移" tabindex="-1"><a class="header-anchor" href="#数据迁移"><span>数据迁移</span></a></h2><p>好在作者勤快提供了迁移的脚本，可以在<a href="https://docs.lsky.pro/archive/free/v2/#%E8%BF%81%E7%A7%BB%E8%84%9A%E6%9C%AC%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">迁移脚本配置</a>中找到，或者直接点击<a href="https://github.com/lsky-org/lsky-pro/releases/download/2.0/migrate.zip" target="_blank" rel="noopener noreferrer">下载迁移脚本</a>。</p><p>建议将下载的脚本上传到站点的目录下，可以在站点的根目录下新建一个<code>update-to-v2</code>的文件夹，将下载的脚本上传到该目录下并解压。</p><p>解压完成后可以看到有个<code>start.php</code>的脚本执行文件和<code>config.yaml</code>的配置文件。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b46a926d8.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>打开<code>config.yaml</code>，编辑里面的新旧数据库连接配置。保证运行脚本的环境可以同时连接到这两个不同的数据库。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b50e2f0ad.png" alt="63e8b50e2f0ad" tabindex="0" loading="lazy"><figcaption>63e8b50e2f0ad</figcaption></figure><p>使用 ssh 工具登录到服务器，cd 到脚本所在的目录，执行下面的迁移命令：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sh"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">php</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start.php</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> migrate</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>此时会出现迁移处理的进度条，表示正在迁移图片数据，如果你的图片量很多，那么等待的时间可能很久，过程中请不要关闭窗口、断网，当进度条走完以后，则数据迁移完成。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8b5ac1f72b.png" alt="63e8b5ac1f72b" tabindex="0" loading="lazy"><figcaption>63e8b5ac1f72b</figcaption></figure><h2 id="图片迁移" tabindex="-1"><a class="header-anchor" href="#图片迁移"><span>图片迁移</span></a></h2><p>上述操作只是将数据库中的数据迁移了过来，脚本并不会迁移实际的图片文件资源。由于使用的是本地存储的策略，所以还得手动将图片文件资源迁移过来。</p><p>只需要将旧版本 <code>public</code> 目录下的图片文件，复制到新版本中的 <code>storage/app/uploads</code> 目录下。</p><h2 id="后续操作" tabindex="-1"><a class="header-anchor" href="#后续操作"><span>后续操作</span></a></h2><p>由于我们一直是需要使用旧站点<code>https://image.liubing.me</code>域名的，可以将旧站点的目录重命名在后面加一个<code>-bak</code>以做备份，将新建站点的目录修改成和旧站点之前的目录名一致。</p><p>此时登录旧的站点<code>https://image.liubing.me</code>会发现页面已经成最新的 2x 版本的了。登录完成后在<code>储存策略</code>的<code>本地策略</code>中将<code>访问网址</code>和<code>储存路径</code>修改成新的。</p><figure><img src="https://image.liubing.me/i/2023/02/12/63e8bae8b3fc9.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><h2 id="重定向配置" tabindex="-1"><a class="header-anchor" href="#重定向配置"><span>重定向配置</span></a></h2><p>一切都 OK 后通过<code>https://image.liubing.me/2023/01/14/5457a8a4d653c.png</code>形式访问会 404。<br> 因为新迁移后的图片访问需要在域名后面加个<code>i</code>变成如下地址：<br><code>https://image.liubing.me/i/2023/01/14/5457a8a4d653c.png</code>即可正常访问了。</p><p>但是我们之前的域名地址后面是不带<code>i</code>，需要将这些地址重定向到带<code>i</code>的地址。可以通过添加以下的 nginx 配置完成匹配和重定向。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($request_uri ~* ^/[0-9]+/[0-9]+/[0-9]+/.+) {</span></span>
<span class="line"><span>  return 301 https://$host/i$request_uri;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://image.liubing.me/i/2023/02/12/63e8bbde03d61.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>一切完成测试 OK 的话就可以将之前的<code>img.liubing.me</code>站点停用了。</p>`,57)])])}const s=i(p,[["render",r]]),g=JSON.parse('{"path":"/article/baota/bt-update-lsky-pro-to-2x.html","title":"宝塔面板升级兰空图床 Lsky Pro 到 2x 版本","lang":"zh-CN","frontmatter":{"date":"2023-02-12T00:00:00.000Z","category":["宝塔面板","Lsky Pro","自部署"],"tag":["Lsky Pro","宝塔面板","图床"],"layout":"ArticleLayout","containerClass":"article-container","description":"之前一直用的是兰空图床 Lsky Pro，版本也是 1x 的版本，里面也上传了不少的图片，最近看到该图床也升级到了 2x 的版本，看了下升级指南才知道 2x 版本与 1x 存在巨大差异需要手动升级，乘着周末有时间搞一下，记录下升级过程。","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"宝塔面板升级兰空图床 Lsky Pro 到 2x 版本\\",\\"image\\":[\\"https://image.liubing.me/i/2023/02/12/63e8aeeaefef5.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8af7c468f6.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b01b67cf2.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b19bab8c5.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b2759afaf.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b33ae497f.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b46a926d8.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b50e2f0ad.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8b5ac1f72b.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8bae8b3fc9.png\\",\\"https://image.liubing.me/i/2023/02/12/63e8bbde03d61.png\\"],\\"datePublished\\":\\"2023-02-12T00:00:00.000Z\\",\\"dateModified\\":\\"2025-08-04T01:08:27.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Bing🐣\\"}]}"],["meta",{"property":"og:url","content":"https://liubing.me/article/baota/bt-update-lsky-pro-to-2x.html"}],["meta",{"property":"og:site_name","content":"Bing🐣"}],["meta",{"property":"og:title","content":"宝塔面板升级兰空图床 Lsky Pro 到 2x 版本"}],["meta",{"property":"og:description","content":"之前一直用的是兰空图床 Lsky Pro，版本也是 1x 的版本，里面也上传了不少的图片，最近看到该图床也升级到了 2x 的版本，看了下升级指南才知道 2x 版本与 1x 存在巨大差异需要手动升级，乘着周末有时间搞一下，记录下升级过程。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://image.liubing.me/i/2023/02/12/63e8aeeaefef5.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-04T01:08:27.000Z"}],["meta",{"property":"article:tag","content":"图床"}],["meta",{"property":"article:tag","content":"宝塔面板"}],["meta",{"property":"article:tag","content":"Lsky Pro"}],["meta",{"property":"article:published_time","content":"2023-02-12T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-04T01:08:27.000Z"}]]},"git":{"createdTime":1676197312000,"updatedTime":1754269707000,"contributors":[{"name":"liub1934","username":"liub1934","email":"liub1934@gmail.com","commits":6,"url":"https://github.com/liub1934"}]},"readingTime":{"minutes":5.25,"words":1576},"filePathRelative":"article/baota/bt-update-lsky-pro-to-2x.md","excerpt":"\\n<p>之前一直用的是兰空图床 Lsky Pro，版本也是 1x 的版本，里面也上传了不少的图片，最近看到该图床也升级到了 2x 的版本，看了下<a href=\\"https://docs.lsky.pro/archive/free/v2/#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">升级指南</a>才知道 2x 版本与 1x 存在巨大差异需要手动升级，乘着周末有时间搞一下，记录下升级过程。</p>\\n","autoDesc":true}');export{s as comp,g as data};
